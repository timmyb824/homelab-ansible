---
- name: Provision Linux Server
  hosts: all
  become: true
  gather_facts: true
  roles:
    - role: alloy
      alloy_loki_url: "https://loki.local.timmybtech.com/loki/api/v1/push"
      alloy_custom_args: "--server.http.listen-addr=0.0.0.0:12345"
      alloy_state: present # or latest/absent
      tags: [alloy, monitoring, logging]

    - role: node_exporter
      node_exporter_version: "1.9.1"
      node_exporter_state: present # or latest/absent
      tags: [node_exporter, monitoring]

    - role: podman
      podman_state: present # or latest/absent
      podman_symlink_docker: false
      tags: [podman, containers]

    - role: anyappstart
      anyappstart_state: present # or latest/absent
      anyappstart_service_user: "root"
      tags: [anyappstart, apps]

    - role: k3s_image_prune
      tags: [k3s_image_prune, k3s, maintenance]
      when: "'k8s' in group_names"

    - role: scrutiny-collector
      scrutiny_collector_state: present # or latest/absent
      tags: [scrutiny-collector, monitoring]

- name: Upgrade Prometheus
  hosts: prometheus
  become: true
  roles:
    - role: prometheus
      tags: [prometheus, upgrade]
